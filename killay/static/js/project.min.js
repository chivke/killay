class SequenceEngine{constructor({data_id:e="sequences-data",menu_id:t="sequences-menu",display_id:s="sequences-display",display_title_id:n="sequences-display-title",display_content_id:i="sequences-display-content",player_id:c="player",debug:_=!1}={}){this.data_element=document.getElementById(e),this.menu_element=document.getElementById(t),this.display_title_element=document.getElementById(n),this.display_content_element=document.getElementById(i),this.sequences_data={},this.debug=_,this._current_second=0}run(){this._load_sequences_data(),$player.on("timeupdate",this.callback_timeupdate.bind(this))}get sequence_ids(){return Object.keys(this.sequences_data)}get last_sequence(){return this.sequences_data[this.last_sequence_id]}get_sequence_by_id(e){return this.sequences_data[e]}get_sequence_by_value_field({field:e,value:t}={}){for(let s=0;s<this.sequence_ids.length;s++){let n=this.get_sequence_by_id(this.sequence_ids[s]);if(n[e]==t)return n}}get_sequence_by_time(e){for(let t=0;t<this.sequence_ids.length;t++){this.sequence_ids[t];let s=this.get_sequence_by_id(this.sequence_ids[t]);if(s&&this.is_time_in_sequence(e,s))return s}}get_sequence_by_order(e){return this.get_sequence_by_value_field({field:"order",value:e})}is_time_in_sequence(e,t){return e>=t.ini&&e<t.end}_debug(e){this.debug&&console.log(e)}_load_sequences_data(){let e=this.data_element.children.length;this._debug(`loading sequences data (${e})`);for(let t=0;t<e;t++){let e=this.data_element.children[t],s=this._get_sequence_obj_from_element(e);this.sequences_data[s.id]=s,t+1==this.data_element.children.length&&(this.last_sequence_id=s.id,this.last_sequence_second=s.end),this._create_selector_in_menu(s)}}_get_sequence_obj_from_element(e){return{id:e.getAttribute("id"),order:parseInt(e.getAttribute("order")),ini:parseInt(e.getAttribute("ini")),end:parseInt(e.getAttribute("end")),title:e.children.namedItem("sequence-data-title").textContent,content:e.children.namedItem("sequence-data-content").cloneNode(!0),selector:null}}_create_selector_in_menu(e){let t=document.createElement("a");return t.setAttribute("class","item"),t.setAttribute("id",e.id),t.setAttribute("ini",e.ini),t.setAttribute("end",e.end),t.onclick=this.callback_select_sequence_onclick.bind(this),t.appendChild(document.createTextNode(e.order)),e.selector=t,this.menu_element.appendChild(t),t}clean_sequence_selectors(){for(let e=0;e<this.menu_element.children.length;e++){this.menu_element.children[e].setAttribute("class","item")}}clean_sequence_display(){this.display_title_element.textContent="",this.display_content_element.textContent=""}select_sequence(e){this.clean_sequence_selectors(),this.current_sequence=e,e.selector.setAttribute("class","item active"),this.display_sequence(e),this._debug(`sequence ${e.order} manual selected`)}display_sequence(e){parseInt($player.currentTime)!=e.ini&&($player.currentTime=e.ini),this.clean_sequence_display(),this.display_title_element.appendChild(document.createTextNode(e.title)),this.display_content_element.appendChild(e.content),$player.play()}callback_select_sequence_onclick(e){let t=e.target.getAttribute("id"),s=this.get_sequence_by_id(t);this.select_sequence(s)}select_sequence_by_time(e){let t=this.get_sequence_by_time(e);return t&&this._debug(`sequence ${t.order} founded by time: ${e}s`),t?this.select_sequence(t):null}callback_timeupdate(e){let t=parseInt($player.currentTime);if(this._current_second==t)return;if(this._current_second=t,this._debug(`current second: ${t} [${$player.currentTime}]`),!this.current_sequence)return this._debug("current sequence not founded"),this.select_sequence_by_time(t);if(this.current_sequence&&this.is_time_in_sequence(t,this.current_sequence))return void this._debug(`current time (${t}s) in sequence ${this.current_sequence.order}`);if(t>this.last_sequence_second)return this._debug(`curren time (${t}s) out of sequences (>${this.last_sequence_second}s)`),void(this.current_sequence.id!=this.last_sequence_id&&this.select_sequence(this.last_sequence));let s=this.get_sequence_by_order(this.current_sequence.order+1);if(s&&this.is_time_in_sequence(t,s))return this._debug(`change sequence ${this.current_sequence.order} to de next sequence ${s.order}`),void this.select_sequence(s);this._debug(`searching sequence for current time (${t}s)`);let n=this.get_sequence_by_time(t);return n?this.select_sequence(n):null}}